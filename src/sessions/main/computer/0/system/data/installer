local version = "https://raw.githubusercontent.com/danielmills/Core/master/release/data/inf/version"
local data = "https://raw.githubusercontent.com/danielmills/Core/master/release/data/inf/data"

function update()
  sh.out("STARTING INSTALLATION FOR UPDATE!")
  sh.out("Checking system install.")
  if isInstalled() then
    sh.out("System install looks fine.")
  else breakout("No install found. Reinstall.") end
  
  sh.out("Checking connection...")
  if isConnected() then
    sh.out("Connected.")
  else breakout("Problems connecting.") end
  sh.out("Downloading the latest files...")
  
  local dat = adownload(data)
  if dat == false then
    sh.out("No data?")
    breakout("Cant find any data?")
  end
  local lin = {}
  sh.out("Reading install data...")
  while true do
    local dk = dat.readLine()
    if dk then table.insert(lin, dk) else break end
  end
  
  for i,v in ipairs(lin) do
    sh.out("Found " .. v)
  end
end

function breakout(msg)
  sh.out("ERROR INSTALLING REBOOT in 3s")
  sh.out(msg)
  os.sleep(3)
  sh.restart()
end

function isInstalled()
  return fs.exists("/system/data/version")
end

function getVersion()
  local f = fs.open("/system/data/version", "r")
  local v = f.readLine()
  f.close()
  return v
end

function isConnected()
  local content = http.get("http://google.com/")
  
  if content then
    content = content.readAll()
  else
    return false
  end
  
  if not content then
    return false
  else
    return true
  end
end

function isUpdated()
  if isConnected() then
    local rv = download(version)
    if rv ~= false then
      rv = tonumber(rv)
      af = fs.open("/system/data/version", "r")
      av = tonumber(af.readLine())
      af.close()
      
      if av < rv then
        sh.out("From V"..av.." > V"..rv)
        return false
      else
        return true
      end
    else
      return nil
    end
  else
    return nil
  end
end

function download(uri)
  local content = http.get(uri)
  
  if content then
    content = content.readAll()
  else
    return false
  end
  
  if not content then
    return false
  else
    return content
  end
end

function adownload(uri)
  local content = http.get(uri)
  
  if content then
    return content
  else
    return false
  end
end