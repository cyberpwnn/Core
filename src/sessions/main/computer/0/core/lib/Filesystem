local PATH = CPI.getPath()
local r = "r"
local w = "w"
local a = "a"
local b = "b"

local loaded = {}

local File = CPI.object()
local Collection = CPI.object()

CPI.onStop(function() closeAll() end)

function open(d, m)
  local self = CPI.object(File)
  self.d = d
  self.m = m
  self.i = #loaded +1
  
  table.insert(loaded, {self.d, fs.open(d,m)})
  CPI.inf("FS: Opened " .. d)
  
  return self
end

function File:write(s) loaded[self.i][2].write(s) return self end
function File:writeLine(s) loaded[self.i][2].writeLine(s) return self end
function File:read() return loaded[self.i][2].read() end
function File:readAll() return loaded[self.i][2].readAll() end
function File:readLine() return loaded[self.i][2].readLine() end
function File:close(s) loaded[self.i][2].close() loaded[self.i] = nil end
function File:flush(s) loaded[self.i][2].flush() return self end

function closeAll()
  local loadedv = loaded
  if #loadedv == 0 then return false end
  CPI.inf("FS: Closing "..#loadedv .. " Files")
  for i,v in ipairs(loadedv) do
    CPI.wrn("FS: Closing File " .. v[1])
    v[2].close()
  end
  loaded = {}
end

function newCollection(d)
  local self = CPI.object(Collection)
  self.l = {}
  self:add(d)
  return self
end

function Collection:add(l)
  if fs.exists(l) then
    if fs.isDir(l) then
      for i,v in ipairs(fs.list(l)) do
        self:add(l.."/"..v)
      end
    end
    if not self:is(l) then
      if l:sub(1,2) == "//" then table.insert(self.l, l:sub(2)) else table.insert(self.l, l) end
    end
  end
end

function Collection:output(l)
  local f = open(l..".col", "w")
  local s = ""
  local d = ""
  local n = 0
  
  for i,v in ipairs(self.l) do
    -- Gather Data and store it to s,d,n
    if fs.isDir(v) then
      d = d .. "D"..n
      s = s .. v
    else
      d = d .. "F"..n
      local fv = open(v, "r")
      local fd = ""
      if fv then
        fd = fv:readAll()
        if fd then s = s .. fd end
        fv:close()
      end
    end
    n = s:len()
  end
  
  -- Additional Processing
  d = "X"..n..d
  
  -- Output
  f:write(s..d):flush():close()
end

function Collection:extract()
  
end

function Collection:is(l)
  for i,v in ipairs(self.l) do
    if v == l then return true end
  end
  return false
end

function Collection:list()
  return self.l
end
